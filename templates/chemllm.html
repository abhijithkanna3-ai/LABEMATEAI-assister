{% extends "base.html" %}

{% block title %}ChemLLM - LabMate AI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Chat Interface -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-brain me-2"></i>
                            ChemLLM - Advanced Chemistry AI
                        </h4>
                        <div class="d-flex align-items-center">
                            <span class="badge" id="modelStatus" 
                                  class="{% if model_info.status == 'loaded' %}bg-success{% elif model_info.status == 'dependencies_missing' %}bg-warning{% elif model_info.status == 'disabled' %}bg-secondary{% else %}bg-danger{% endif %}">
                                {% if model_info.status == 'loaded' %}
                                    <i class="fas fa-check-circle me-1"></i>Model Ready
                                {% elif model_info.status == 'dependencies_missing' %}
                                    <i class="fas fa-exclamation-triangle me-1"></i>Dependencies Missing
                                {% elif model_info.status == 'disabled' %}
                                    <i class="fas fa-pause-circle me-1"></i>Temporarily Disabled
                                {% else %}
                                    <i class="fas fa-exclamation-triangle me-1"></i>Model Not Available
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body d-flex flex-column">
                    <!-- Model Information -->
                    <div class="alert alert-info mb-3" id="modelInfo">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Model:</strong> {{ model_info.model_name }}<br>
                                <strong>Device:</strong> {{ model_info.device }}<br>
                                <strong>Type:</strong> {{ model_info.model_type }}
                            </div>
                            <div class="col-md-6">
                                <strong>Status:</strong> 
                                <span class="{% if model_info.status == 'loaded' %}text-success{% elif model_info.status == 'dependencies_missing' %}text-warning{% elif model_info.status == 'disabled' %}text-secondary{% else %}text-danger{% endif %}">
                                    {{ model_info.status.replace('_', ' ')|title }}
                                </span><br>
                                <strong>Parameters:</strong> 7.74B<br>
                                <strong>Specialization:</strong> Chemistry & Molecule Science
                                {% if model_info.status == 'dependencies_missing' %}
                                <br><small class="text-warning"><strong>Install:</strong> pip install torch transformers einops accelerate</small>
                                {% elif model_info.status == 'disabled' %}
                                <br><small class="text-info"><strong>Note:</strong> ChemLLM is temporarily disabled for better performance</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="chat-messages flex-grow-1 mb-3" id="chatMessages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                        {% if model_info.status == 'dependencies_missing' %}
                        <div class="welcome-message text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                            <h5>Dependencies Required</h5>
                            <p>ChemLLM requires PyTorch and Transformers libraries to function.</p>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-download me-2"></i>Installation Required</h6>
                                <p class="mb-2">To use ChemLLM, please install the required dependencies:</p>
                                <code>pip install torch transformers einops accelerate</code>
                                <br><small class="text-muted">Or use: <code>pip install -r requirements_chemllm.txt</code></small>
                                <hr>
                                <p class="mb-0"><strong>Note:</strong> This will download the ChemLLM model (~15GB) on first use.</p>
                            </div>
                        </div>
                        {% elif model_info.status == 'disabled' %}
                        <div class="welcome-message text-center text-muted">
                            <i class="fas fa-pause-circle fa-3x mb-3 text-secondary"></i>
                            <h5>ChemLLM Temporarily Disabled</h5>
                            <p>ChemLLM has been temporarily disabled to improve application performance.</p>
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Temporarily Disabled</h6>
                                <p class="mb-2">ChemLLM is currently disabled for better performance. You can still use:</p>
                                <ul class="text-start">
                                    <li><strong>Regular Chatbot:</strong> Gemini-powered chemistry assistance</li>
                                    <li><strong>Calculator:</strong> Chemical calculations and conversions</li>
                                    <li><strong>MSDS:</strong> Chemical safety information</li>
                                    <li><strong>All other features:</strong> Working normally</li>
                                </ul>
                                <hr>
                                <p class="mb-0"><strong>Note:</strong> ChemLLM can be re-enabled later when needed.</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="welcome-message text-center text-muted">
                            <i class="fas fa-atom fa-3x mb-3"></i>
                            <h5>Welcome to ChemLLM!</h5>
                            <p>Ask me anything about chemistry, molecular science, reactions, or laboratory procedures.</p>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-flask text-primary fa-2x mb-2"></i>
                                            <h6>Chemical Reactions</h6>
                                            <small>Mechanisms, kinetics, thermodynamics</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <i class="fas fa-microscope text-success fa-2x mb-2"></i>
                                            <h6>Laboratory Procedures</h6>
                                            <small>Techniques, protocols, safety</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <i class="fas fa-calculator text-warning fa-2x mb-2"></i>
                                            <h6>Calculations</h6>
                                            <small>Stoichiometry, concentrations, pH</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="chat-input">
                        <div class="input-group">
                            <textarea class="form-control" id="messageInput" 
                                      placeholder="Ask me about chemistry, reactions, laboratory procedures, or molecular science..." 
                                      rows="3" maxlength="1000"></textarea>
                            <button class="btn btn-primary" type="button" id="sendBtn" 
                                    {% if model_info.status != 'loaded' %}disabled{% endif %}>
                                <i class="fas fa-paper-plane me-1"></i>Send
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <span class="example-link" data-example="Explain the mechanism of SN2 reactions">SN2 Mechanism</span> |
                                <span class="example-link" data-example="How do I calculate the pH of a buffer solution?">pH Calculation</span> |
                                <span class="example-link" data-example="What are the safety precautions for working with concentrated sulfuric acid?">Safety</span> |
                                <span class="example-link" data-example="Describe the molecular structure of benzene and its properties">Benzene Structure</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Panel -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Generation Settings
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Model Parameters -->
                    <div class="mb-4">
                        <h6>Model Parameters</h6>
                        
                        <div class="mb-3">
                            <label for="maxLength" class="form-label">Max Length: <span id="maxLengthValue">512</span></label>
                            <input type="range" class="form-range" id="maxLength" min="100" max="1024" value="512">
                            <small class="text-muted">Maximum number of tokens to generate</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="temperature" class="form-label">Temperature: <span id="temperatureValue">0.7</span></label>
                            <input type="range" class="form-range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.7">
                            <small class="text-muted">Controls randomness (0.1 = focused, 2.0 = creative)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="topP" class="form-label">Top-p: <span id="topPValue">0.9</span></label>
                            <input type="range" class="form-range" id="topP" min="0.1" max="1.0" step="0.1" value="0.9">
                            <small class="text-muted">Controls diversity of word choices</small>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mb-4">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" id="clearChat">
                                <i class="fas fa-trash me-1"></i>Clear Chat
                            </button>
                            <button class="btn btn-outline-info btn-sm" id="checkStatus">
                                <i class="fas fa-sync me-1"></i>Check Model Status
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="exportChat">
                                <i class="fas fa-download me-1"></i>Export Chat
                            </button>
                        </div>
                    </div>
                    
                    <!-- Model Information -->
                    <div class="mb-4">
                        <h6>Model Information</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <small>
                                    <strong>ChemLLM-7B-Chat-1.5-DPO</strong><br>
                                    • 7.74B parameters<br>
                                    • Specialized for chemistry<br>
                                    • Based on InternLM-2<br>
                                    • DPO fine-tuned<br>
                                    • Supports molecular science
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Usage Tips -->
                    <div>
                        <h6>Usage Tips</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <small>
                                    <strong>Best Practices:</strong><br>
                                    • Be specific with your questions<br>
                                    • Include context when needed<br>
                                    • Ask for step-by-step explanations<br>
                                    • Request safety information<br>
                                    • Use proper chemical nomenclature
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Generating Response...</h5>
                <p class="text-muted">ChemLLM is processing your question. This may take a few moments.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chemllm.js') }}"></script>
{% endblock %}
